<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>API Usage Statistics</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">

  <!-- Latest compiled and minified JavaScript -->
  <script
    src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <style>
    td {
      word-wrap: break-word;
    }
  </style>
</head>

<body>

<div class="container-fluid">
  <div class="panel panel-default">
    <div class="panel-heading">Query</div>
    <div class="panel-body">
      <form id="query" class="form-horizontal">
        <div class="form-group">
          <label for="ts_from" class="col-md-1 control-label">From date:</label>

          <div class="col-md-2">
            <input id="ts_from" type="date" class="form-control">
          </div>
        </div>
        <div class="form-group">
          <label for="ts_to" class="col-md-1 control-label">To date:</label>

          <div class="col-md-2">
            <input id="ts_to" type="date" class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label for="fields" class="col-md-1 control-label">Group by:</label>

          <div class="col-md-2">
            <input id="fields" type="text" class="form-control"
                   value="endpoint,userEmail">
          </div>
          <p class="help-block">
            Available fields:
            endpoint, status, appId, appName, userId, userEmail.
          </p>
        </div>

        <div class="form-group">
          <div class="col-sm-12">
            <button class="btn btn-default">Refresh</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <table id="stats" class="table table-bordered" width="100%">
  </table>

  <script type="application/javascript">
    var $table = $('#stats');

    initDateInputs();

    $('form#query').submit(function(event) {
      event.preventDefault();
      refresh();
    });

    $(refresh);

    function initDateInputs() {
      var firstOfLastMonth = new Date();
      firstOfLastMonth.setDate(1);
      firstOfLastMonth.setMonth(firstOfLastMonth.getMonth()-1);
      $('#ts_from').val(firstOfLastMonth.toISOString().slice(0, 10));

      $('#ts_to').val(new Date().toISOString().slice(0, 10));
    }

    function refresh() {
      $table.find('tr').remove();

      var ts_from = getDateFromInputId('#ts_from');
      var ts_to = getDateFromInputId('#ts_to');
      var fields = $('#fields').val().split(/, */);

      $.get(
        'api/MetricEvents/aggregate',
        {
          from: ts_from.toISOString(),
          to: ts_to.toISOString(),
          fields: JSON.stringify(fields)
        },
        function(data) {
          renderEvents(fields.concat(['count']), data);
        })
        .fail(function(err) {
          alert('Cannot download data', err);
        }
      )
    }

    function renderEvents(fields, events) {
      $table.append($('<tr/>').append(fields.map(function(name) {
        return $('<th/>').text(name);
      })));

      $table.append(events.map(function(data) {
        var cells = fields.map(function(f) {
          return $('<td/>').text(data[f] !== null ? data[f] : '');
        });
        return $('<tr/>').append(cells);
      }));
    }

    function getDateFromInputId(id) {
      var value = new Date($(id).val());
      return value.getTime() === NaN ? new Date() : value;
    }

  </script>
</div>
</body>
</html>

